#include "RadioDriver.h"

static uint16_t sequenceNumber = 0;

static Semaphore_Handle radioSemaphore;

void RDserializePacket(EasyLink_TxPacket *txPacket, struct RDPacket *rdPacket)
{
    txPacket->payload[0] = sequenceNumber >> 8;
    txPacket->payload[1] = sequenceNumber & 0xFF;
    txPacket->payload[2] = (rdPacket->requestAck & 0x01) & ((rdPacket->isAck & 0x01) << 1);
    txPacket->payload[3] = rdPacket->type;
    uint16_t i;
    for (i = 0; i < RD_DATA_LENGTH; i++)
    {
        txPacket->payload[4 + i] = rdPacket->data[i];
    }
}

void RDdeserializePacket(EasyLink_RxPacket *rxPacket, struct RDPacket *rdPacket, uint16_t *sequenceNumber)
{
    *sequenceNumber = (rxPacket->payload[0] << 8) | rxPacket->payload[1];
    rdPacket->requestAck = (rxPacket->payload[2] & 0x01);
    rdPacket->isAck = (rxPacket->payload[2] & 0x02) >> 1;
    rdPacket->type = rxPacket->payload[3];
    uint16_t i;
    for (i = 0; i < RD_DATA_LENGTH; i++)
    {
        rdPacket->data[i] = rxPacket->payload[4 + i];
    }
}

enum RDStatus sendPacketInternally(struct RDPacket *packet, uint8_t maxRetries)
{
    EasyLink_TxPacket txPacket = {{0}, 0, 0, {0}};
    RDserializePacket(&txPacket, packet);

    EasyLink_Status result = EasyLink_transmit(&txPacket);

    if (result != EasyLink_Status_Success)
    {
        return RD_ERROR;
    }

    EasyLink_RxPacket rxPacket = {{0}, 0, 0, 0, 0, {0}};

    uint8_t retries = 0;

    while (retries < maxRetries)
    {
        result = EasyLink_receive(&rxPacket);

        if (result == EasyLink_Status_Success)
        {
            uint16_t receivedSequenceNumber = 0;
            RDPacket receivedPacket = {0};
            RDdeserializePacket(&rxPacket, &receivedPacket, &receivedSequenceNumber);

            if (receivedSequenceNumber == sequenceNumber)
            {
                if (receivedPacket.isAck == 1)
                {
                    sequenceNumber++;
                    return RD_OK;
                }
            }
        }
        retries++;
    }
    sequenceNumber++;
    if (maxRetries == 0)
    {
        return RD_OK;
    }

    return RD_TIMEOUT;
}

RDStatus RDsendPacketAck(struct RDPacket *packet, uint8_t maxRetries)
{
    Semaphore_pend(radioSemaphore, BIOS_WAIT_FOREVER);
    packet->isAck = 0;
    packet->requestAck = 1;
    RDStatus status = sendPacketInternally(packet, maxRetries);
    Semaphore_post(radioSemaphore);
    return status;
}

enum RDStatus RDsendPacket(struct RDPacket *packet)
{
    Semaphore_pend(radioSemaphore, BIOS_WAIT_FOREVER);
    packet->isAck = 0;
    packet->requestAck = 0;
    enum RDStatus status = sendPacketInternally(packet, 0);
    Semaphore_post(radioSemaphore);
    return status;
}

enum RDStatus RDreceivePacket(RDPacket *packet)
{

    Semaphore_pend(radioSemaphore, BIOS_WAIT_FOREVER);

    EasyLink_RxPacket rxPacket = {{0}, 0, 0, 0, 0, {0}};

    EasyLink_Status result = EasyLink_receive(&rxPacket);

    if (result == EasyLink_Status_Success)
    {
        uint16_t receivedSequenceNumber = 0;
        struct RDPacket receivedPacket = {0};
        RDdeserializePacket(&rxPacket, &receivedPacket, &receivedSequenceNumber);

        if (receivedPacket.isAck == 1)
        {
            // Ignore packet
        }
        else if (receivedPacket.requestAck == 1)
        {
            // Send ack
            receivedPacket.isAck = 1;
            receivedPacket.requestAck = 0;
            return sendPacketInternally(&receivedPacket, 0);
        }
        Semaphore_post(radioSemaphore);
        return RD_OK;
    }
    Semaphore_post(radioSemaphore);
    return RD_TIMEOUT;
}

void RDinitialize()
{

    Semaphore_Params semaphore_params;
    Semaphore_Params_init(&semaphore_params);
    Error_Block eb;
    Error_init(&eb);

    radioSemaphore = Semaphore_create(1, &semaphore_params, &eb);
    if (radioSemaphore == NULL)
    {
        System_abort("Semaphore creation failed");
    }

    EasyLink_Params easyLink_params;
    EasyLink_Params_init(&easyLink_params);

    if (EasyLink_init(&easyLink_params) != EasyLink_Status_Success)
    {
        System_abort("EasyLink_init failed");
    }
}
